name: Windows Binary Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build-windows:
    name: Build Windows Binary (${{ matrix.variant }})
    runs-on: windows-2025  # Faster I/O with Dev Drive support

    strategy:
      fail-fast: false  # Continue other builds even if one fails
      matrix:
        variant:
          - name: standard
            features: ""
            suffix: "standard"
          - name: directml
            features: "--features directml"
            suffix: "directml"
          - name: openvino
            features: "--features openvino"
            suffix: "openvino"
          - name: cuda
            features: "--features cuda"
            suffix: "cuda"

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 1

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Cache OpenCV
        id: cache-opencv
        uses: actions/cache@v4
        with:
          path: C:\opencv
          key: opencv-4.12.0-windows

      - name: Download and extract OpenCV
        if: steps.cache-opencv.outputs.cache-hit != 'true'
        run: |
          curl -L https://github.com/opencv/opencv/releases/download/4.12.0/opencv-4.12.0-windows.exe -o opencv.exe
          7z x opencv.exe -oC:\ -y
          Remove-Item opencv.exe

      - name: Setup OpenCV environment
        run: |
          echo "OPENCV_LINK_LIBS=opencv_world4120" >> $env:GITHUB_ENV
          echo "OPENCV_LINK_PATHS=C:\opencv\build\x64\vc16\lib" >> $env:GITHUB_ENV
          echo "OPENCV_INCLUDE_PATHS=C:\opencv\build\include" >> $env:GITHUB_ENV

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9
        continue-on-error: true

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          shared-key: "release-${{ matrix.variant.name }}"
          cache-on-failure: true

      - name: Configure build environment
        run: |
          echo "SCCACHE_GHA_ENABLED=true" >> $env:GITHUB_ENV
          echo "RUSTC_WRAPPER=sccache" >> $env:GITHUB_ENV
          echo "CARGO_INCREMENTAL=0" >> $env:GITHUB_ENV
          echo "CARGO_TERM_COLOR=always" >> $env:GITHUB_ENV

      - name: Build release binary (${{ matrix.variant.name }})
        run: cargo build --release --locked --target x86_64-pc-windows-msvc ${{ matrix.variant.features }}

      - name: Upload artifact (${{ matrix.variant.name }})
        uses: actions/upload-artifact@v4
        with:
          name: manga_workflow-windows-x86_64-${{ matrix.variant.suffix }}
          path: target/x86_64-pc-windows-msvc/release/manga_workflow.exe

  release:
    name: Create Release
    needs: build-windows
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag'

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: binaries

      - name: Prepare release files
        run: |
          mkdir -p release
          mv binaries/manga_workflow-windows-x86_64-standard/manga_workflow.exe release/manga_workflow_standard.exe
          mv binaries/manga_workflow-windows-x86_64-directml/manga_workflow.exe release/manga_workflow_directml.exe
          mv binaries/manga_workflow-windows-x86_64-openvino/manga_workflow.exe release/manga_workflow_openvino.exe
          mv binaries/manga_workflow-windows-x86_64-cuda/manga_workflow.exe release/manga_workflow_cuda.exe
          ls -lh release/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/manga_workflow_standard.exe
            release/manga_workflow_directml.exe
            release/manga_workflow_openvino.exe
            release/manga_workflow_cuda.exe
          draft: false
          prerelease: false
          body: |
            ## Windows Builds
            - `manga_workflow_standard.exe` - CPU only
            - `manga_workflow_directml.exe` - DirectML GPU acceleration (AMD/Intel/NVIDIA)
            - `manga_workflow_openvino.exe` - OpenVINO optimization (Intel CPUs)
            - `manga_workflow_cuda.exe` - CUDA GPU acceleration (NVIDIA)

            ## Installation
            1. Clone the repository: `git clone <repo-url>`
            2. Install Git LFS: `git lfs install && git lfs pull`
            3. Build with: `cargo build --release --features directml`
            4. DirectML.dll v1.15.4 is auto-copied to output (fixes System32 v1.8 conflict)

            ## Pre-built Binaries
            Download executables above and clone repo to get required libraries (DirectML.dll via Git LFS).
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
